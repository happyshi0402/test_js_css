var user_info;var list_city;$(document).ready(function(){var error=false;$("#oldpass").focus(function(){showTip("oldpass","请输入当前密码！")});$("#oldpass").blur(function(){var oldpass=$("#oldpass").val();if(oldpass==""){showError("oldpass","当前密码不能为空！");error=true;return}else{showOk("oldpass")}});$("#newpass").focus(function(){showTip("newpass","密码由6-12位半角字符组成，区分大小写（不能是9位以下纯数字，不能包含空格）。")});$("#newpass").blur(function(){var newpass=$("#newpass").val();if(newpass==""){showError("newpass","新密码不能为空！");error=true}if(regPsw(newpass)){showOk("newpass")}else{showError("newpass","格式错误！");error=true}});$("#newpassAgain").focus(function(){showTip("newpassAgain","请再次输入新密码！")});$("#newpassAgain").blur(function(){var newpass=$("#newpass").val();var newpassAgain=$("#newpassAgain").val();if(newpassAgain!=newpass){showError("newpassAgain","与输入的新密码不一致！");error=true}else{if(newpassAgain==""){return}else{showOk("newpassAgain")}}});$("#submit_loginName").click(function(){error=false;$("#oldpass").blur();$("#newpass").blur();$("#newpassAgain").blur();if(!error){var oldpass=$("#oldpass").val();var newpass=$("#newpass").val();var pwd={oldpass:oldpass,newpass:newpass};$.ajax({url:"/change/password/",type:"POST",data:pwd,success:function(data){var jsonData=eval("("+data+")");if(jsonData.status==0){sweetAlert(jsonData.message);$("#login-name").collapse("hide")}else{if(jsonData.status==102){showError("oldpass","当前密码错误！")}else{showError("submitPass",jsonData.message)}}},error:function(xhr){sweetAlert("Search Fail:"+xhr.statusText+xhr.status)}})}});$("#university").blur(function(){var str_eduinfo=$("#university").val();if(str_eduinfo.length>14){showError("university","不能超过13个字！");error=true}else{if(str_eduinfo==""){showError("university","教育信息不能为空！");error=true}else{$("#universityTip").css({display:"none"})}}});$("#institute").blur(function(){var str_work=$("#institute").val();if(str_work.length>41){showError("institute","不能超过40个字！");error=true}else{if(str_work==""){showError("institute","工作单位不能为空！");error=true}else{$("#instituteTip").css({display:"none"})}}});$("#personal_profile").blur(function(){var str_resume=$("#personal_profile").val();if(str_resume.length>91||str_resume.length<10){showError("personal_profile","字数范围为10至90字！");error=true}else{if(str_resume==""){showError("personal_profile","个人简介不能为空！");error=true}else{$("#personal_profileTip").css({display:"none"})}}});$("#submit_personalData").click(function(){error=false;$("#university").blur();$("#institute").blur();$("#personal_profile").blur();if(!error){var formdata=new FormData(document.forms.namedItem("personal_data_form"));$.ajax({type:"POST",url:"/update/user/info/",data:formdata,cache:false,contentType:false,processData:false,success:function(data){var jsonData=eval("("+data+")");if(jsonData.status==2){sweetAlert(jsonData.message);$("#user_personal_profile").text($("#personal_profile").val());$("#personal_data").collapse("hide")}else{sweetAlert(jsonData.message)}},error:function(xhr){sweetAlert("Search Fail:"+xhr.statusText+xhr.status)}})}});$("#upfile").change(function(){var formdata=new FormData(document.forms.namedItem("upload_form"));if(this.value){$.ajax({type:"POST",url:"/user/info/avatar/",data:formdata,cache:false,contentType:false,processData:false,success:function(data){$("#user_avatar2").attr("src",data);$("#user_avatar").attr("src",data)},error:function(xhr){sweetAlert("Search Fail:"+xhr.statusText+xhr.status)}})}});$("#save_avatar").click(function(){var iamgeUrl=$("#user_avatar2").attr("src");var imageUrlData="avatar="+iamgeUrl;$.ajax({type:"PUT",url:"/user/info/avatar/",data:imageUrlData,success:function(data){var jsonData=eval("("+data+")");if(jsonData.status==2){sweetAlert("修改头像成功！");$("#head-portrait").collapse("hide")}else{sweetAlert(jsonData.message)}},error:function(xhr){sweetAlert("Search Fail:"+xhr.statusText+xhr.status)}})});$("#real_name").focus(function(){showTip("real_name","请填写你的真实姓名，认证后不能修改。")});$("#real_name").blur(function(){var str_name=$("#real_name").val();if(isCardName(str_name)){showOk("real_name")}else{showError("real_name","格式不对，姓名是2-15字的汉字！");error=true}});$("#id_value").focus(function(){showTip("id_value","请填写你的身份证号码，认证后不能修改。")});$("#id_value").blur(function(){var str_card=$("#id_value").val();if(isIdCard(str_card)){showOk("id_value")}else{showError("id_value","证件格式不对！");error=true}});$("#submit_certificate").click(function(){error=false;$("#real_name").blur();$("#id_value").blur();if(!error){var formdata=new FormData(document.forms.namedItem("certificate_form"));$.ajax({type:"POST",url:"/user/info/id/",data:formdata,cache:false,contentType:false,processData:false,success:function(data){console.log(data);var jsonData=eval("("+data+")");if(jsonData.status==2){sweetAlert("证件信息修改成功！");var html_str="<p>证件信息</p>-姓名："+$("#real_name").val()+"  身份证号："+$("#id_value").val()+'<span class="pull-right text-pink">不可编辑</span>';$("#user_certificate").html(html_str);$("#certificate").hide()}else{sweetAlert(jsonData.message)}},error:function(xhr){sweetAlert("Search Fail:"+xhr.statusText+xhr.status)}})}});$("#mail").blur(function(){var str_mail=$("#mail").val();if(isEmail(str_mail)){showOk("mail")}else{showError("mail","邮箱格式错误！");error=true}});$("#submit_mail").click(function(event){error=false;$("#mail").blur();if(!error){sweetAlert("电子邮箱填写完成！")}});if(window.location.href.split("#")[1]=="2"){$("#myTab>li").removeClass("active");$("#myTab>li:eq(2)").addClass("active");$("#myTabContent>div").removeClass("in active");$("#myTabContent>div:eq(2)").addClass("in active")}$.get("/personal/user_info_conf/",function(user_info_conf_data){console.log("********************开始获取个人信息*********************");var user_info_conf_data=eval("("+user_info_conf_data+")");console.log("用户配置信息获取成功：",user_info_conf_data);var user_info_conf=user_info_conf_data.user_info_conf;list_city=user_info_conf.list_city;set_select_start_option(user_info_conf.list_province,"province_id");set_select_start_option(user_info_conf.list_research_field,"research_field_id");set_select_start_option(user_info_conf.list_profession,"profession_id");user_info=get_user_info()})});function get_user_info(){var result=eval("("+$("#saveUserinfo").val()+")");console.log("获取个人信息为：",result);if(result.status==2){user_info=result.data;console.log("开始设置个人信息（非下拉框部分）*********************");set_user_info(user_info);console.log("开始设置个人信息（下拉框部分）*********************");set_select_option(user_info.province||"北京市","province_id");set_select_start_option(list_city,"city_id",1,user_info.province_id||"1");set_select_option(user_info.city_id||"北京市","city_id");set_select_option(user_info.degree||"1","degree");set_select_option(user_info.research_field_id||"系统生物学","research_field_id");set_select_option(user_info.profession_id||"医生","profession_id");console.log("********************设置个人信息成功！*********************")}else{sweetAlert("获取用户信息时发生异常："+result.message)}}function selectMoreCity(b){var a=$(b).find("option:selected").val();set_select_start_option(list_city,"city_id",1,a)}function set_select_option(a,e){if(a!=null){var d=document.getElementById(e);var c=d.options.length;if(e=="degree"){for(var b=0;b<c;b++){if(a==d.options[b].value){d.options[b].selected=true}}}else{for(var b=0;b<c;b++){if(a==d.options[b].text){d.options[b].selected=true}}}}}function set_select_start_option(k,a,g,h){if(k.error==true){}else{if(k.status==2){var f=k.list;var b=f.length;var e=document.getElementById(a);e.innerHTML="";var c=0;for(var d=0;d<b;d++){if(g==1){if(f[d].province_id==h){e.options[c]=new Option(f[d].name,f[d].id);c++}else{}}else{e.options[d]=new Option(f[d].name,f[d].id)}}}}}function set_user_info(a){if(a!=null){var d=(a.sex?a.sex:0);var f=document.getElementById("sex");var e=f.length;for(var c=0;c<e;c++){if(d==f.options[c].value){f.options[c].selected=true}else{f.options[c].selected=false}}var h=(a.degree?a.degree:0);var g=document.getElementById("degree");e=g.length;for(var c=0;c<e;c++){if(h=g.options[c].value){g.options[c].selected=true}else{g.options[c].selected=false}}if(a.real_name!=null||a.id_type!=null||a.id_value!=null){var b="<p>证件信息</p>-姓名："+a.real_name+"  身份证号："+a.id_value+'<span class="pull-right text-pink">不可编辑</span>';$("#user_certificate").html(b);$("#certificate").hide()}$("#user_avatar").attr("src",a.avatar?a.avatar:"/static/avatar/null.jpg");$("#user_avatar2").attr("src",a.avatar?a.avatar:"/static/avatar/null.jpg");$("#span_user_account").text(a.account);$("#span_user_email").text(a.email?a.email:"您还没有绑定邮箱！");$("#user_account").text(a.account);$("#user_personal_profile").text(a.personal_profile?a.personal_profile:"您还没有填写个人简介！");$("#real_name").val(a.real_name);$("#id_value").val(a.id_value);$("#university").val(a.university);$("#institute").val(a.institute);$("#personal_profile").text(a.personal_profile?a.personal_profile:"您还没有填写个人简介！")}};